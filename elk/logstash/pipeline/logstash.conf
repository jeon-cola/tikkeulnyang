input {
  beats {
    port => 5044
  }
  tcp {
    port => 5000
    codec => json
  }
}

filter {
  # Spring Boot 로그 처리
  if [fields][type] == "spring-boot" {
    grok {
      match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:log_level} %{DATA:thread} %{DATA:class} - %{GREEDYDATA:log_message}" }
    }

    date {
      match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSS" ]
      target => "@timestamp"
    }

    # 로그인 시도 감지
    if [log_message] =~ "login attempt" {
      mutate {
        add_field => { "event_type" => "login_attempt" }
      }

      # 로그인 성공 or 실패 구분
      if [log_message] =~ "failed" or [log_message] =~ "invalid" {
        mutate {
          add_field => { "login_status" => "failed" }
          add_tag => [ "security_alert" ]
        }
      } else if [log_message] =~ "success" {
        mutate {
          add_field => { "login_status" => "success" }
        }
      }
    }

    # 금융 거래 감지
    if [log_message] =~ "transaction" or [log_message] =~ "payment" or [log_message] =~ "transfer" {
      mutate {
        add_field => { "event_type" => "financial_transaction" }
        add_tag => [ "transaction" ]
      }

      # 거래 금액 추출 (예시 패턴)
      grok {
        match => { "log_message" => ".*amount.*:?\s*%{NUMBER:transaction_amount:float}" }
      }

      # 이상 거래 탐지 (고액 거래)
      if [transaction_amount] and [transaction_amount] > 1000000 {
        mutate {
          add_tag => [ "high_value_transaction", "financial_alert" ]
        }
      }
    }
  }

  # Docker 로그 처리
  if [container] {
    mutate {
      add_field => { "environment" => "docker" }
    }

    # 컨테이너별 로그 분류
    if [container][name] =~ "mysql" {
      mutate {
        add_field => { "service" => "database" }
      }
    } else if [container][name] =~ "backend" {
      mutate {
        add_field => { "service" => "api" }
      }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "%{[fields][type]}-%{+YYYY.MM.dd}"
    manage_template => false
  }

  # 보안 관련 이벤트는 별도 인덱스로 저장
  if "security_alert" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "security-events-%{+YYYY.MM.dd}"
    }
  }

  # 금융 거래 관련 이벤트는 별도 인덱스로 저장
  if "transaction" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "financial-transactions-%{+YYYY.MM.dd}"
    }
  }
}